#-------Screenshot code
@pytest.hookimpl(hookwrapper=True)
def pytest_runtest_makereport(item, call):
    outcome = yield
    rep = outcome.get_result()

    if rep.when == 'call' and rep.failed:
        driver = getattr(getattr(item, "cls", None), "driver", None)
        if driver:
            screenshot_dir = os.path.join(os.getcwd(), "Screenshots")
            os.makedirs(screenshot_dir, exist_ok=True)
            screenshot_path = os.path.join(screenshot_dir, f"{item.name}.png")
            try:
                driver.save_screenshot(screenshot_path)
            except Exception as e:
                print(f"[WARN] Could not save screenshot: {e}")


#-------------------------Test cases executor-------------------
# Utils/excel_test_selector.py
import openpyxl

class ExcelTestSelector:
    def __init__(self, file_path):
        self.file_path = file_path

    def get_selected_tests(self):
        workbook = openpyxl.load_workbook(self.file_path)
        sheet = workbook.active
        selected_tests = []

        for row in sheet.iter_rows(min_row=2, values_only=True):  # Skip header
            test_name, execute_flag = row
            if execute_flag and execute_flag.strip().upper() == "Y":
                selected_tests.append(test_name.strip())

        return selected_tests



#-------------------------------------------------

@pytest.hookimpl(tryfirst=True, hookwrapper=True)
def pytest_runtest_makereport(item, call):
    outcome = yield
    report = outcome.get_result()

    driver = item.funcargs.get("driver")  # get driver fixture
    if driver is None:
        return

    screenshot_util = ScreenshotUtil(driver)
    test_name = item.name

    if report.when == "call":  # after test execution
        if report.failed:
            screenshot_util.take_screenshot(test_name, status="Fail")
        elif report.passed:
            screenshot_util.take_screenshot(test_name, status="Pass")

